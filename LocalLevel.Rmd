---
title: "LocalLevel"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The Package and Data Introduction 

```{r, results='hide',message=FALSE,warning=FALSE,eval=FALSE}
library(readstata13)
library(dplyr)
library(rstan)
library(BBmisc)
library(purrr)
library(ggplot2)
library(bayesplot)

# When the data shows some 'local independency', we may consider the local level model 
rstan_options(auto_write = TRUE)
options (mc.cores = parallel :: detectCores())

df_raw =read.csv("./sales.txt", sep=",")

mod = stan_model ('./LocalLevel.stan')
data_input = list(
  n = nrow(df_raw),
  y = df_raw$sales
)
```

# MLE
Run multipler times to get the best solution
```{r, results='hide',message=FALSE,warning=FALSE,eval=FALSE}
mle_res = NULL
mle_value = -Inf
i = 1
while (i<50){
  temp = optimizing (mod, data = data_input,
                     #verbose = TRUE,
                     hessian = TRUE, as_vector = FALSE)
  if (temp$value>mle_value){
    mle_res = temp
    mle_value = temp$value
  }
  i = i+1
}

```

## Bayesian Estimation 
We next produce bayesian estiation results
```{r, results='hide',message=FALSE,warning=FALSE,eval=FALSE}
Bayesian_res = stan(file = 'LocalLevel.stan',
                    data = data_input, 
                    chains = 4,
                    iter = 2000,
                    warmup = 1000,
                    thin = 1)
```
### A glance at the results
first use the print to check the result. two important criteria: n_eff, Rhat
```{r, results='hide',message=FALSE,warning=FALSE,eval=FALSE}
print(Bayesian_res,pars = "sigma_level", probs = c(0.025,0.5, 0.975))
```
also can do the traceplot, which reflects the sampling process. check whether the sampling has converged (become stable)or not. 
```{r, results='hide',message=FALSE,warning=FALSE,eval=FALSE}
traceplot (Bayesian_res, pars = 'sigma_level',
           inc_warmup = F
           )
```

### Detailed Check
#### Sample Extraction
#### Diagnostic Analysis
- Independence
- Error Rate
- Homoscadasticity
- Normality of the residual 
